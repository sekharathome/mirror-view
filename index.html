<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>SystemSync Console</title>

<style>

body{
    margin:0;
    background:#050505;
    color:#e0e0e0;
    font-family:Segoe UI;
    display:flex;
    flex-direction:column;
    align-items:center;
}

header{
    width:100%;
    padding:18px;
    background:#000;
    border-bottom:1px solid #111;
    text-align:center;
    font-size:22px;
    color:#00d2ff;
}

#panel{
    margin-top:20px;
    background:#0f0f0f;
    padding:20px;
    border-radius:12px;
    border:1px solid #222;
    width:480px;
}

select,button{
    padding:10px;
    border:none;
    border-radius:6px;
    margin:6px;
}

button{
    cursor:pointer;
    font-weight:bold;
}

.start{
    background:#00d2ff;
}

.stop{
    background:#ff4b2b;
    color:white;
}

video{
    margin-top:15px;
    width:100%;
    border-radius:10px;
    background:black;
}

.status{
    margin-top:10px;
    font-size:14px;
}

</style>
</head>

<body>

<header>
SystemSync Remote Console
</header>

<div id="panel">

<b>Select Device</b><br>

<select id="device-selector"></select>

<button onclick="connectToDevice()">CONNECT</button>

<br><br>

<button class="start" onclick="sendCommand('START_SCREEN')">
START STREAM
</button>

<button class="stop" onclick="sendCommand('STOP_SCREEN')">
STOP STREAM
</button>

<video id="screen-display" autoplay playsinline></video>

<div id="status" class="status">Connecting to server...</div>

</div>

<script>

const SERVER = "wss://mirror-view.onrender.com";
const socket = new WebSocket(SERVER);

let pc;
let selectedDevice = null;

// --------------------
// CONNECT TO SIGNALING
// --------------------

socket.onopen = () => {

    updateStatus("Connected to signaling server");

    socket.send(JSON.stringify({
        type:"REGISTER_CONTROLLER"
    }));
};

// --------------------
// RECEIVE SIGNALS
// --------------------

socket.onmessage = async (event)=>{

    const msg = JSON.parse(event.data);

    switch(msg.type){

        case "DEVICE_LIST":
            populateDevices(msg.devices);
            break;

        case "OFFER":

            await createPeer();

            await pc.setRemoteDescription(
                new RTCSessionDescription(msg)
            );

            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            socket.send(JSON.stringify({
                type:"ANSWER",
                sdp:answer.sdp
            }));

            break;

        case "ICE":

            if(pc){
                pc.addIceCandidate(msg.candidate);
            }

            break;
    }
};

// --------------------
// DEVICE LIST
// --------------------

function populateDevices(devices){

    const selector =
        document.getElementById("device-selector");

    selector.innerHTML="";

    devices.forEach(d=>{

        const opt=document.createElement("option");

        opt.value=d.id;
        opt.text=d.name;

        selector.appendChild(opt);
    });
}

// --------------------
// CONNECT TO DEVICE
// --------------------

function connectToDevice(){

    selectedDevice =
        document.getElementById("device-selector").value;

    socket.send(JSON.stringify({
        type:"SELECT_DEVICE",
        deviceId:selectedDevice
    }));

    updateStatus("Device selected");
}

// --------------------
// CREATE WEBRTC PEER
// --------------------

async function createPeer(){

    pc = new RTCPeerConnection({

        iceServers:[
            {urls:"stun:stun.l.google.com:19302"}
        ]
    });

    pc.ontrack = e => {

        document
            .getElementById("screen-display")
            .srcObject = e.streams[0];

        updateStatus("Streaming LIVE");
    };

    pc.onicecandidate = e => {

        if(e.candidate){

            socket.send(JSON.stringify({
                type:"ICE",
                candidate:e.candidate
            }));
        }
    };
}

// --------------------
// SEND COMMAND
// --------------------

function sendCommand(cmd){

    if(!selectedDevice){
        alert("Select a device first!");
        return;
    }

    socket.send(JSON.stringify({
        type:"COMMAND",
        command:cmd
    }));
}

// --------------------

function updateStatus(text){
    document.getElementById("status").innerText = text;
}

</script>

</body>
</html>
