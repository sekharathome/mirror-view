<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SystemSync Pro Viewer</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { position: relative; width: 360px; height: 640px; border: 4px solid #333; border-radius: 12px; background: #000; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas { width: 100%; height: 100%; display: block; }
        .controls { margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 10px; display: flex; gap: 10px; align-items: center; }
        button { padding: 10px 18px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        #start { background: #28a745; color: white; }
        #stop { background: #dc3545; color: white; }
        #snap { background: #007bff; color: white; }
        button:disabled { background: #444; opacity: 0.6; cursor: not-allowed; }
        #status { margin-bottom: 10px; font-size: 13px; color: #888; }
        label { font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

    <h2>SystemSync Pro</h2>
    <div id="status">Status: Offline</div>

    <div class="container">
        <canvas id="canvas" width="360" height="640"></canvas>
    </div>

    <div class="controls">
        <button id="start">START</button>
        <button id="stop" disabled>STOP</button>
        <label><input type="checkbox" id="audioSync"> Audio</label>
        <button id="snap">SNAP</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('status');
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const audioSync = document.getElementById('audioSync');
        const snapBtn = document.getElementById('snap');

        const SERVER_URL = "wss://mirror-view.onrender.com"; 

        let ws = null;
        let vDecoder = null;
        let aDecoder = null;
        let audioCtx = null;
        let waitingForKey = true;

        async function initDecoders() {
            vDecoder = new VideoDecoder({
                output: (frame) => { ctx.drawImage(frame, 0, 0); frame.close(); },
                error: (e) => { console.error(e); waitingForKey = true; }
            });
            await vDecoder.configure({ codec: 'avc1.42E01E', codedWidth: 360, codedHeight: 640 });

            if (audioSync.checked) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                aDecoder = new AudioDecoder({
                    output: (data) => handleAudioOutput(data),
                    error: (e) => console.error(e)
                });
                await aDecoder.configure({ codec: 'mp4a.40.2', sampleRate: 44100, numberOfChannels: 1 });
            }
        }

        startBtn.onclick = async () => {
            statusText.innerText = "Status: Connecting...";
            startBtn.disabled = true;
            stopBtn.disabled = false;
            waitingForKey = true;

            await initDecoders();

            ws = new WebSocket(SERVER_URL);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => statusText.innerText = "Status: Live (Syncing...)";
            
            ws.onmessage = (e) => {
                const data = new Uint8Array(e.data);
                const type = data[0]; // 0=Video, 1=Audio
                const payload = data.slice(1);

                if (type === 0) {
                    const isKey = payload.length > 5000;
                    if (waitingForKey && !isKey) return;
                    if (isKey) { waitingForKey = false; statusText.innerText = "Status: Streaming Live"; }

                    if (vDecoder.state === "configured") {
                        vDecoder.decode(new EncodedVideoChunk({
                            type: isKey ? 'key' : 'delta',
                            timestamp: performance.now(),
                            data: payload
                        }));
                    }
                } else if (type === 1 && aDecoder && aDecoder.state === "configured") {
                    aDecoder.decode(new EncodedAudioChunk({
                        type: 'key', timestamp: performance.now(), data: payload
                    }));
                }
            };

            ws.onclose = () => handleStop();
        };

        stopBtn.onclick = handleStop;

        function handleStop() {
            if (ws) ws.close();
            if (vDecoder && vDecoder.state !== "closed") vDecoder.close();
            if (aDecoder && aDecoder.state !== "closed") aDecoder.close();
            if (audioCtx) audioCtx.close();
            
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            statusText.innerText = "Status: Offline";
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        function handleAudioOutput(data) {
            const buffer = audioCtx.createBuffer(1, data.numberOfFrames, 44100);
            data.copyTo(buffer.getChannelData(0), { planeIndex: 0 });
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start();
        }

        snapBtn.onclick = () => {
            const link = document.createElement('a');
            link.download = `sync-snap-${Date.now()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        };
    </script>
</body>
</html>
