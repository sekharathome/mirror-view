<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SystemSync - Professional Panel</title>
    <style>
        :root { --sidebar-bg: #34495e; --active-teal: #1abc9c; --main-bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--main-bg); overflow: hidden; }
        
        #sidebar { width: 250px; background: var(--sidebar-bg); color: #ecf0f1; display: flex; flex-direction: column; flex-shrink: 0; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #2c3e50; transition: 0.3s; }
        .nav-item.active { background: var(--active-teal); }
        
        #main-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        
        #content-area { padding: 30px; flex-grow: 1; overflow-y: auto; }
        .live-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        
        canvas { max-width: 100%; border: 2px solid #34495e; border-radius: 5px; background: #000; }
        .btn-start { background: var(--active-teal); color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-stop { background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        
        #log-window { background: #2c3e50; color: #1abc9c; padding: 15px; border-radius: 5px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 13px; margin-top: 20px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding: 20px; font-size: 20px; font-weight: bold; background: #2c3e50;">SystemSync Pro</div>
    <div class="nav-item active">Live Viewing</div>
    <div class="nav-item">Device Info</div>
    <div class="nav-item">Remote Logs</div>
    <div class="nav-item">Settings</div>
</div>

<div id="main-wrapper">
    <header>
        <div>Status: <span id="status-ind" style="font-weight: bold; color: red;">OFFLINE</span></div>
        <div id="device-meta">Battery: <span id="batt-lvl">--</span> <span id="charge-stat"></span></div>
    </header>

    <div id="content-area">
        <div id="setup-view" class="live-card">
            <h3>Stream Configuration</h3>
            
            <div style="margin-bottom: 20px;">
                <label>Audio Source:</label>
                <select id="audio-opt" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="off">No Audio</option>
                    <option value="mic">Microphone</option>
                    <option value="system">System Audio (Android 10+)</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn-start" onclick="startStream()">â–¶ START SCREEN</button>
                <button onclick="takeShot()" style="margin-left:10px; padding: 12px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">SNAPSHOT</button>
            </div>

            <div>
                <input type="checkbox" id="record-toggle"> <label for="record-toggle">Record session to browser</label>
            </div>
        </div>

        <div id="stream-view" style="display:none;">
            <button class="btn-stop" onclick="stopStream()">STOP STREAM</button>
            <div class="live-card">
                <canvas id="display"></canvas>
            </div>
        </div>

        <div id="log-window">
            <div id="logs">SYSTEM: Panel initialized. Waiting for device...</div>
        </div>
    </div>
</div>

<script>
    const socket = new WebSocket('wss://mirror-view.onrender.com');
    const canvas = document.getElementById('display');
    const ctx = canvas.getContext('2d');
    let isStreaming = false;
    let audioCtx = null;
    let nextAudioTime = 0;

    socket.onmessage = (event) => {
        const data = event.data;

        if (data.startsWith("FRAME:") && isStreaming) {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = "data:image/jpeg;base64," + data.substring(6);
        }
        else if (data.startsWith("AUDIO:")) {
            playPcm(data.substring(6));
        }
        else if (data.startsWith("STATUS:")) {
            const s = data.substring(7);
            document.getElementById('status-ind').innerText = s;
            document.getElementById('status-ind').style.color = (s === "ONLINE") ? "green" : "red";
        }
        else if (data.startsWith("LOG:")) {
            const div = document.createElement('div');
            div.innerText = `> ${data.substring(4)}`;
            const logs = document.getElementById('logs');
            logs.appendChild(div);
            document.getElementById('log-window').scrollTop = logs.scrollHeight;
        }
    };

    function playPcm(base64) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const binary = atob(base64);
        const bytes = new Int16Array(binary.length / 2);
        for (let i = 0; i < bytes.length; i++) {
            bytes[i] = (binary.charCodeAt(i * 2) & 0xFF) | (binary.charCodeAt(i * 2 + 1) << 8);
        }
        const buffer = audioCtx.createBuffer(1, bytes.length, 44100);
        const channelData = buffer.getChannelData(0);
        for (let i = 0; i < bytes.length; i++) {
            channelData[i] = bytes[i] / 32768.0;
        }
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        const startTime = Math.max(audioCtx.currentTime, nextAudioTime);
        source.start(startTime);
        nextAudioTime = startTime + buffer.duration;
    }

    function startStream() {
        const audio = document.getElementById('audio-opt').value;
        socket.send(`START_SCREEN:${audio}`);
        document.getElementById('setup-view').style.display = 'none';
        document.getElementById('stream-view').style.display = 'block';
        isStreaming = true;
    }

    function stopStream() {
        socket.send("STOP_SCREEN");
        document.getElementById('setup-view').style.display = 'block';
        document.getElementById('stream-view').style.display = 'none';
        isStreaming = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function takeShot() {
        const link = document.createElement('a');
        link.download = `snap_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
