<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SystemSync Pro Control</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 10px; }
        
        /* Flash Message for Screen Off */
        #flashMsg {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #ffc107; color: #000; padding: 15px 25px; border-radius: 8px;
            font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .container { margin: 10px auto; width: 320px; height: 568px; border: 4px solid #222; background: #000; border-radius: 15px; overflow: hidden; }
        canvas { width: 100%; height: 100%; background: #000; }
        
        .panel { background: #1a1a1a; padding: 15px; border-radius: 12px; display: inline-block; margin-top: 10px; width: 90%; max-width: 400px; }
        button { padding: 12px 20px; margin: 5px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; color: white; min-width: 130px; }
        <button id="vibrateBtn" style="background:#ff5722">VIBRATE PHONE</button>
        .btn-start { background: #28a745; }
        .btn-stop { background: #dc3545; }
        
        #logWindow { 
            background: #000; color: #0f0; font-family: monospace; font-size: 11px; 
            height: 100px; overflow-y: scroll; text-align: left; padding: 10px; 
            margin-top: 10px; border: 1px solid #333; border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="flashMsg">⚠️ MOBILE SCREEN IS OFF - UNLOCK PHONE TO SEE VIDEO</div>

    <h2>SystemSync Pro</h2>
    
    <div class="container">
        <canvas id="canvas" width="360" height="640"></canvas>
    </div>

    <div class="panel">
        <button id="toggleBtn" class="btn-start">START VIEWING</button>
        <button id="stealthBtn" style="background:#6f42c1">HIDE ICON</button>
        <button id="snapBtn" style="background:#444">SNAP</button>

        <div id="logWindow">--- Debug Logs ---<br></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const logWin = document.getElementById('logWindow');
        const toggleBtn = document.getElementById('toggleBtn');
        const flashMsg = document.getElementById('flashMsg');
        const stealthBtn = document.getElementById('stealthBtn');

        let ws = null, vDec = null, isConnected = false, isHidden = false, waitingForKey = true;

        function addLog(msg) {
            logWin.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
            logWin.scrollTop = logWin.scrollHeight;
        }

        toggleBtn.onclick = () => { if (!isConnected) startStreaming(); else stopStreaming(); };

        async function startStreaming() {
            addLog("Initializing...");
            vDec = new VideoDecoder({
                output: f => { ctx.drawImage(f, 0, 0); f.close(); flashMsg.style.display = 'none'; },
                error: e => addLog("Decoder Error: " + e)
            });
            await vDec.configure({ codec: 'avc1.42E01E', codedWidth: 360, codedHeight: 640 });

            ws = new WebSocket("wss://mirror-view.onrender.com");
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                isConnected = true;
                toggleBtn.innerText = "STOP VIEWING";
                toggleBtn.className = "btn-stop";
                addLog("Connected to Server.");
            };

            ws.onmessage = e => {
                if (typeof e.data === "string") {
                    if (e.data === "ALERT:SCREEN_OFF") {
                        flashMsg.style.display = 'block';
                        addLog("ALERT: Mobile screen is OFF");
                    }
                    return;
                }

                const data = new Uint8Array(e.data);
                if (data[0] === 0) {
                    const payload = data.slice(1);
                    const isKey = payload.length > 4000;
                    if (waitingForKey && !isKey) return;
                    waitingForKey = false;
                    vDec.decode(new EncodedVideoChunk({ type: isKey?'key':'delta', timestamp: performance.now(), data: payload }));
                }
            };

            ws.onclose = () => stopStreaming();
        }

        function stopStreaming() {
            if (ws) ws.close();
            if (vDec && vDec.state !== "closed") vDec.close();
            isConnected = false;
            flashMsg.style.display = 'none';
            toggleBtn.innerText = "START VIEWING";
            toggleBtn.className = "btn-start";
            addLog("Disconnected.");
        }
const vibrateBtn = document.getElementById('vibrateBtn');

vibrateBtn.onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send("REMOTE_VIBRATE");
        addLog("Sent Vibrate Command");
    } else {
        alert("Connect to stream first!");
    }
}
        stealthBtn.onclick = () => {
            if (!ws) return;
            isHidden = !isHidden;
            ws.send(isHidden ? "HIDE_ICON" : "SHOW_ICON");
            stealthBtn.innerText = isHidden ? "SHOW ICON" : "HIDE ICON";
            addLog(isHidden ? "Sent Hide Command" : "Sent Show Command");
        };
    </script>
</body>
</html>

