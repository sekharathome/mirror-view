<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SystemSync Private Viewer</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { position: relative; width: 320px; height: 568px; border: 4px solid #333; border-radius: 12px; background: #000; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        .controls { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 12px 20px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }
        #start { background: #28a745; color: white; }
        #stop { background: #dc3545; color: white; }
        #snap { background: #007bff; color: white; }
        button:disabled { background: #444; opacity: 0.6; cursor: not-allowed; }
        #status { margin-bottom: 10px; font-size: 14px; color: #888; }
    </style>
</head>
<body>

    <h2>SystemSync Mirror</h2>
    <div id="status">Status: Disconnected</div>

    <div class="container">
        <canvas id="canvas" width="720" height="1280"></canvas>
    </div>

    <div class="controls">
        <button id="start">START VIEWING</button>
        <button id="stop" disabled>STOP</button>
        <button id="snap" disabled>SNAPSHOT</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('status');
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const snapBtn = document.getElementById('snap');

        const SERVER_URL = "wss://mirror-view.onrender.com"; 

        let ws = null;
        let decoder = null;
        let waitingForKey = true;

        async function start() {
            waitingForKey = true;
            statusText.innerText = "Status: Connecting...";
            
            decoder = new VideoDecoder({
                output: (frame) => {
                    ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
                    frame.close();
                },
                error: (e) => {
                    console.error(e);
                    waitingForKey = true;
                }
            });

            await decoder.configure({ 
                codec: 'avc1.42E01E', 
                codedWidth: 720, 
                codedHeight: 1280 
            });

            ws = new WebSocket(SERVER_URL);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                statusText.innerText = "Status: Live (Waiting for Frame...)";
                startBtn.disabled = true;
                stopBtn.disabled = false;
                snapBtn.disabled = false;
            };

            ws.onmessage = (e) => {
                const view = new Uint8Array(e.data);
                let isKey = false;

                // NALU Header Search: 00 00 00 01
                for (let i = 0; i < view.length - 5; i++) {
                    if (view[i] === 0 && view[i+1] === 0 && view[i+2] === 0 && view[i+3] === 1) {
                        const naluType = view[i+4] & 0x1f;
                        if (naluType === 5 || naluType === 7) { // IDR or SPS
                            isKey = true;
                            break;
                        }
                    }
                }

                if (waitingForKey) {
                    if (isKey) {
                        waitingForKey = false;
                        statusText.innerText = "Status: Streaming Live";
                    } else {
                        return; // Drop frames until a keyframe arrives
                    }
                }

                if (decoder.state === "configured") {
                    try {
                        decoder.decode(new EncodedVideoChunk({
                            type: isKey ? 'key' : 'delta',
                            timestamp: performance.now(),
                            data: e.data
                        }));
                    } catch (err) {
                        waitingForKey = true;
                    }
                }
            };

            ws.onclose = () => stop();
        }

        function stop() {
            if (ws) ws.close();
            if (decoder && decoder.state !== "closed") decoder.close();
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            statusText.innerText = "Status: Disconnected";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            snapBtn.disabled = true;
        }

        startBtn.onclick = start;
        stopBtn.onclick = stop;

        snapBtn.onclick = () => {
            const link = document.createElement('a');
            link.download = `sync-snap-${Date.now()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        };
    </script>
</body>
</html>
