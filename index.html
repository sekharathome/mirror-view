<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SystemSync - Professional Control Panel</title>
    <style>
        :root { --sidebar-bg: #2c3e50; --teal: #1abc9c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); }
        
        /* Sidebar */
        #sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; }
        .side-header { padding: 25px; font-size: 20px; font-weight: bold; background: #1a252f; text-align: center; }
        .nav-item { padding: 15px 25px; cursor: pointer; border-bottom: 1px solid #34495e; transition: 0.3s; }
        .nav-item.active { background: var(--teal); }

        /* Main Content */
        #main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid #ddd; }
        
        .container { padding: 30px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 700px; text-align: center; }
        
        canvas { background: #000; border-radius: 8px; width: 100%; max-height: 500px; object-fit: contain; border: 5px solid #333; }
        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-start { background: var(--teal); color: white; }
        .btn-stop { background: #e74c3c; color: white; }
        .btn-snap { background: #3498db; color: white; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header">SystemSync Pro</div>
    <div class="nav-item active">Live Streaming</div>
    <div class="nav-item">Device Files</div>
    <div class="nav-item">Action Logs</div>
</div>

<div id="main">
    <header>
        <div><strong>Status:</strong> <span id="status" style="color:red">OFFLINE</span></div>
        <div>Battery: <span id="batt">--%</span></div>
    </header>

    <div class="container">
        <div id="setup-card" class="card">
            <h2>Stream Setup</h2>
            <div style="margin: 20px 0;">
                <label>Audio Source:</label>
                <select id="audio-opt" style="padding:8px; border-radius:4px;">
                    <option value="off">No Audio</option>
                    <option value="mic">Microphone</option>
                    <option value="system">System Audio</option>
                </select>
            </div>
            <div class="controls">
                <button class="btn btn-start" onclick="startStream()">START STREAM</button>
                <button class="btn btn-snap" onclick="takeShot()">SNAPSHOT</button>
            </div>
            <div style="margin-top:15px;">
                <input type="checkbox" id="record-check"> <label>Record session to disk</label>
            </div>
        </div>

        <div id="stream-view" class="card" style="display:none; margin-top:20px;">
            <button class="btn btn-stop" onclick="stopStream()">STOP STREAMING</button>
            <div style="margin-top:15px;">
                <canvas id="display"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = new WebSocket('wss://mirror-view.onrender.com');
    const canvas = document.getElementById('display');
    const ctx = canvas.getContext('2d');
    let isStreaming = false;
    
    // Audio Context for Listening
    let audioCtx = null;
    let nextAudioTime = 0;

    // Recording Variables
    let mediaRecorder;
    let recordedChunks = [];

    socket.onmessage = (event) => {
        const data = event.data;

        if (data.startsWith("FRAME:") && isStreaming) {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = "data:image/jpeg;base64," + data.substring(6);
        }
        else if (data.startsWith("AUDIO:")) {
            playPcm(data.substring(6));
        }
    };

    function playPcm(base64) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const binary = atob(base64);
        const bytes = new Int16Array(binary.length / 2);
        for (let i = 0; i < bytes.length; i++) {
            bytes[i] = (binary.charCodeAt(i * 2) & 0xFF) | (binary.charCodeAt(i * 2 + 1) << 8);
        }
        const buffer = audioCtx.createBuffer(1, bytes.length, 44100);
        buffer.getChannelData(0).set(Array.from(bytes).map(v => v / 32768));
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        const startTime = Math.max(audioCtx.currentTime, nextAudioTime);
        source.start(startTime);
        nextAudioTime = startTime + buffer.duration;
    }

    function startStream() {
        const audio = document.getElementById('audio-opt').value;
        socket.send(`START_SCREEN:${audio}`);
        
        document.getElementById('setup-card').style.display = 'none';
        document.getElementById('stream-view').style.display = 'block';
        isStreaming = true;

        if (document.getElementById('record-check').checked) {
            startRecording();
        }
    }

    function startRecording() {
        const stream = canvas.captureStream(30); // 30 FPS
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
        mediaRecorder.onstop = saveRecording;
        mediaRecorder.start();
    }

    function saveRecording() {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `recording_${Date.now()}.webm`;
        a.click();
        recordedChunks = [];
    }

    function stopStream() {
        socket.send("STOP_SCREEN");
        if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        location.reload(); // Quickest way to reset state
    }

    function takeShot() {
        const link = document.createElement('a');
        link.download = `shot_${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
