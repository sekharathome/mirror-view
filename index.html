<!DOCTYPE html>
<html>
<head>
    <title>High FPS Mirror Control</title>
    <style>
        body { background: #111; color: #fff; font-family: sans-serif; }
        #screenContainer { 
            width: 360px; height: 640px; background: #000; 
            margin: 20px auto; border: 3px solid #444; overflow: hidden;
        }
        #remoteView { width: 100%; height: 100%; object-fit: contain; }
        .controls { margin-top: 20px; }
        button { padding: 12px 24px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        .btn-start { background: #28a745; color: white; }
        .btn-stop { background: #dc3545; color: white; display: none; }
        .btn-action { background: #007bff; color: white; }
    </style>
</head>
<body>
    <h1>Remote Control Panel</h1>
    
    <div id="screenContainer">
        <img id="remoteView" src="" alt="Screen Feed">
    </div>

    <div class="controls">
        <button id="startBtn" class="btn-start" onclick="toggleScreen(true)">VIEW SCREEN</button>
        <button id="stopBtn" class="btn-stop" onclick="toggleScreen(false)">STOP SCREEN</button>
        <br>
        <button class="btn-action" onclick="takeScreenshot()">CAPTURE IMAGE</button>
        <button id="recordBtn" class="btn-action" onclick="toggleRecording()">START RECORDING</button>
    </div>

    <script>
        const ws = new WebSocket('wss://mirror-view.onrender.com');
        const view = document.getElementById('remoteView');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        
        let mediaRecorder;
        let recordedChunks = [];
        let canvasStream;

        ws.onmessage = (event) => {
            const data = event.data;
            if (data.startsWith("FRAME:")) {
                view.src = "data:image/jpeg;base64," + data.replace("FRAME:", "");
            } else if (data === "CLEAR_SCREEN") {
                view.src = ""; // Turns screen black
            }
        };

        function toggleScreen(start) {
            if (start) {
                ws.send("START_SCREEN");
                startBtn.style.display = "none";
                stopBtn.style.display = "inline-block";
            } else {
                ws.send("STOP_SCREEN");
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                view.src = "";
            }
        }

        function takeScreenshot() {
            const link = document.createElement('a');
            link.download = 'capture_' + Date.now() + '.jpg';
            link.href = view.src;
            link.click();
        }

        async function toggleRecording() {
            const recBtn = document.getElementById('recordBtn');
            if (recBtn.innerText === "START RECORDING") {
                // We record the screen by capturing the <img> tag content into a canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 360; canvas.height = 640;
                
                canvasStream = canvas.captureStream(20); // 20 FPS recording
                mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm;codecs=vp8' });
                
                mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
                mediaRecorder.onstop = downloadVideo;

                // Loop to draw the image to canvas for recording
                const drawLoop = setInterval(() => {
                    if (mediaRecorder.state === "inactive") clearInterval(drawLoop);
                    ctx.drawImage(view, 0, 0, canvas.width, canvas.height);
                }, 50);

                mediaRecorder.start();
                recBtn.innerText = "STOP RECORDING";
                recBtn.style.background = "#ffc107";
            } else {
                mediaRecorder.stop();
                recBtn.innerText = "START RECORDING";
                recBtn.style.background = "#007bff";
            }
        }

        function downloadVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'screen_record.webm'; // WebM is the standard for browser recording
            a.click();
            recordedChunks = [];
        }
    </script>
</body>
</html>
