<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SystemSync Pro + Debug Logs</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 10px; }
        .container { margin: 10px auto; width: 320px; height: 568px; border: 4px solid #222; background: #000; border-radius: 15px; overflow: hidden; }
        canvas { width: 100%; height: 100%; background: #000; }
        .panel { background: #1a1a1a; padding: 15px; border-radius: 12px; display: inline-block; margin-top: 10px; width: 90%; max-width: 400px; }
        
        /* Log Window */
        #logWindow { 
            background: #000; color: #0f0; font-family: monospace; font-size: 11px; 
            height: 120px; overflow-y: scroll; text-align: left; padding: 10px; 
            margin-top: 10px; border: 1px solid #333; border-radius: 5px;
        }
        
        button { padding: 12px 20px; margin: 5px; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; color: white; }
        .btn-start { background: #28a745; }
        .btn-stop { background: #dc3545; }
        .settings { margin-top: 10px; font-size: 13px; }
    </style>
</head>
<body>

    <h2>SystemSync Pro</h2>
    
    <div class="container">
        <canvas id="canvas" width="360" height="640"></canvas>
    </div>

    <div class="panel">
        <button id="toggleBtn" class="btn-start">START VIEWING</button>
        <button id="snapBtn" style="background:#444">SNAP</button>
        <div class="settings">
            <label><input type="checkbox" id="audioSync"> Audio</label>
            <button id="stealthBtn" style="background:#6f42c1; padding:5px 10px; font-size:11px;">STEALTH</button>
        </div>

        <div id="logWindow">--- Debug Logs ---<br></div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const logWin = document.getElementById('logWindow');
        const toggleBtn = document.getElementById('toggleBtn');
        
        let ws = null, vDec = null, isConnected = false;

        function addLog(msg) {
            const time = new Date().toLocaleTimeString().split(' ')[0];
            logWin.innerHTML += `[${time}] ${msg}<br>`;
            logWin.scrollTop = logWin.scrollHeight;
        }

        toggleBtn.onclick = () => {
            if (!isConnected) startStreaming();
            else stopStreaming();
        };

        async function startStreaming() {
            addLog("Initializing VideoDecoder...");
            try {
                vDec = new VideoDecoder({
                    output: f => { ctx.drawImage(f, 0, 0); f.close(); },
                    error: e => addLog("Decoder Error: " + e.message)
                });
                await vDec.configure({ codec: 'avc1.42E01E', codedWidth: 360, codedHeight: 640 });
                addLog("Decoder configured (avc1.42E01E)");

                addLog("Connecting to WebSocket...");
                ws = new WebSocket("wss://mirror-view.onrender.com");
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    isConnected = true;
                    toggleBtn.innerText = "STOP VIEWING";
                    toggleBtn.className = "btn-stop";
                    addLog("WS Connected. Waiting for phone data...");
                };

                ws.onmessage = e => {
                    if (typeof e.data === "string") {
                        addLog("Server Msg: " + e.data);
                        return;
                    }

                    const data = new Uint8Array(e.data);
                    const type = data[0]; 
                    const payload = data.slice(1);

                    if (type === 0) { // Video
                        const isKey = payload.length > 4000;
                        if (isKey) addLog("Received Keyframe (" + payload.length + " bytes)");
                        
                        if (vDec.state === "configured") {
                            vDec.decode(new EncodedVideoChunk({
                                type: isKey ? 'key' : 'delta',
                                timestamp: performance.now(),
                                data: payload
                            }));
                        }
                    }
                };

                ws.onclose = () => {
                    addLog("WS Closed by Server.");
                    stopStreaming();
                };

                ws.onerror = (err) => addLog("WS Socket Error.");

            } catch (err) {
                addLog("Setup Failed: " + err.message);
            }
        }

        function stopStreaming() {
            if (ws) ws.close();
            if (vDec && vDec.state !== "closed") vDec.close();
            isConnected = false;
            toggleBtn.innerText = "START VIEWING";
            toggleBtn.className = "btn-start";
            addLog("Streaming Stopped.");
        }
    </script>
</body>
</html>
